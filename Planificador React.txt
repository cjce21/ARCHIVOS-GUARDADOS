import React, { useState, useEffect, useRef, useCallback } from 'react';
import { ChevronDown, Check, X, Paperclip, Image as ImageIcon, Upload, Download, AlertCircle, Layers, AlignLeft, Sparkles, Edit3, Menu, ChevronLeft, ArrowRight, BookOpen } from 'lucide-react';

// --- ESTILOS CSS (Componente Encapsulado) ---
const AppStyles = () => (
    <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@500;600;700;800&display=swap');

        :root {
            --m-blue: #1B4965;
            --m-teal: #3A9D9D;
            --m-red: #C00000;
            --bg-soft: #F9FAFB;
            --border-soft: #E5E7EB;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-soft); color: #1f2937; overflow: hidden; margin: 0; padding: 0; }
        
        /* Scrollbar invisible global */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Evitar scroll horizontal y forzar wrap */
        .no-horizontal-scroll {
            overflow-x: hidden; 
            overflow-y: auto;
            white-space: pre-wrap;       
            overflow-wrap: break-word;   
            word-wrap: break-word;       
        }

        /* Inputs Unificados */
        .input-compact {
            width: 100%;
            min-height: 36px; 
            padding: 8px 10px; 
            font-size: 11px;
            line-height: 1.4;
            border: 1px solid var(--border-soft);
            border-radius: 6px;
            background: white;
            transition: all 0.2s ease;
            color: #374151;
            display: block;
            resize: none;
        }
        
        .input-compact:focus {
            border-color: var(--m-teal);
            box-shadow: 0 0 0 2px rgba(58, 157, 157, 0.1);
            outline: none;
        }
        .input-compact::placeholder { color: #9CA3AF; }

        /* Botones */
        .btn-base {
            display: flex; align-items: center; justify-content: center; gap: 6px;
            border-radius: 6px; font-weight: 700; letter-spacing: 0.3px; font-size: 10px;
            height: 36px; 
            transition: all 0.2s; cursor: pointer; user-select: none; text-transform: uppercase;
            width: 100%;
        }
        .btn-base:active { transform: scale(0.98); }

        /* Animaciones */
        @keyframes slideInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        .animate-slide-up { animation: slideInUp 0.4s ease-out forwards; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .animate-fade-out { animation: fadeOut 0.5s ease-out forwards; }
        .animate-scale-in { animation: scaleIn 0.2s ease-out forwards; }
        .animate-pulse-slow { animation: pulse-slow 2s infinite; }

        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        
        /* Transición sidebar */
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    `}</style>
);

// --- COMPONENTES UI ---

const Toast = ({ message, type, onClose }) => {
    useEffect(() => {
        const timer = setTimeout(onClose, 5000); 
        return () => clearTimeout(timer);
    }, [onClose]);

    const styles = {
        success: 'bg-emerald-50 text-emerald-800 border-emerald-200',
        error: 'bg-red-50 text-red-800 border-red-200',
        info: 'bg-white text-slate-700 border-slate-200',
        loading: 'bg-blue-50 text-blue-800 border-blue-200'
    };

    return (
        <div className={`flex items-center gap-3 px-4 py-3 rounded-lg border shadow-lg animate-slide-up min-w-[300px] max-w-sm backdrop-blur-sm ${styles[type] || styles.info}`}>
            {type === 'success' ? <Check size={16} className="text-emerald-500" /> : 
             type === 'error' ? <AlertCircle size={16} className="text-red-500" /> : <div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>}
            <span className="text-xs font-semibold flex-1 leading-tight">{message}</span>
            <button onClick={onClose} className="opacity-40 hover:opacity-100 transition-opacity"><X size={14} /></button>
        </div>
    );
};

const CustomSelect = ({ value, onChange, options, placeholder, icon: Icon }) => {
    const [isOpen, setIsOpen] = useState(false);
    const containerRef = useRef(null);

    useEffect(() => {
        const handleClickOutside = (e) => {
            if (containerRef.current && !containerRef.current.contains(e.target)) setIsOpen(false);
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    return (
        <div className="relative w-full" ref={containerRef}>
            <div 
                className={`w-full px-3 h-[36px] text-[11px] font-medium border rounded-lg cursor-pointer flex items-center justify-between bg-white text-slate-700 transition-all ${isOpen ? 'border-montessori-blue ring-1 ring-blue-100' : 'border-gray-200 hover:border-gray-300'}`}
                onClick={() => setIsOpen(!isOpen)}
            >
                <div className="flex items-center gap-2 overflow-hidden">
                    {Icon && <Icon size={12} className="text-slate-400 flex-shrink-0" />}
                    <span className={`truncate ${!value ? 'text-slate-400' : 'text-slate-700'}`}>{value || placeholder}</span>
                </div>
                <ChevronDown size={12} className={`text-slate-400 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
            </div>
            {isOpen && (
                <div className="absolute z-50 w-full mt-1 bg-white border border-gray-100 rounded-lg shadow-xl max-h-56 overflow-y-auto animate-fade-in hide-scroll">
                    {options.map((opt, i) => (
                        <div 
                            key={i}
                            className={`px-3 py-2 text-[11px] cursor-pointer border-b border-gray-50 last:border-0 hover:bg-blue-50 hover:text-montessori-blue transition-colors ${value === opt ? 'bg-blue-50 text-montessori-blue font-bold' : 'text-slate-600'}`}
                            onClick={() => { onChange(opt); setIsOpen(false); }}
                        >
                            {opt}
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

// --- MODALES (ESTANDARIZADOS) ---

const ContextModal = ({ isOpen, onClose, contextText, setContextText, attachedImages, setAttachedImages }) => {
    const fileInputRef = useRef(null);
    if (!isOpen) return null;

    const handleImageUpload = (e) => {
        const files = Array.from(e.target.files);
        const newImages = [];
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                newImages.push(ev.target.result);
                if (newImages.length === files.length) setAttachedImages(prev => [...prev, ...newImages]);
            };
            reader.readAsDataURL(file);
        });
    };

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/30 backdrop-blur-sm animate-fade-in p-6">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col max-h-[85vh] animate-scale-in border border-white/50">
                <div className="flex justify-between items-center p-5 border-b border-gray-100">
                    <div className="flex items-center gap-2">
                        <div className="bg-blue-50 p-2 rounded-lg"><Paperclip size={16} className="text-[#1B4965]" /></div>
                        <div>
                            <h3 className="font-bold text-sm text-slate-800">Centro de Recursos</h3>
                            <p className="text-[10px] text-slate-400">Contexto para el sistema</p>
                        </div>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-gray-50 rounded-full text-slate-400 hover:text-red-500 transition-colors"><X size={18}/></button>
                </div>
                
                <div className="p-6 flex-1 overflow-y-auto hide-scroll">
                    <textarea 
                        className="w-full h-40 p-4 rounded-xl bg-gray-50/50 border border-gray-200 text-xs focus:border-[#1B4965] focus:bg-white focus:ring-2 focus:ring-blue-50 outline-none resize-none transition-all placeholder:text-slate-400 leading-relaxed"
                        placeholder="Pegue aquí el contenido de documentos, instrucciones específicas, o detalles curriculares adicionales..."
                        value={contextText}
                        onChange={(e) => setContextText(e.target.value)}
                    ></textarea>

                    <div className="mt-6">
                        <div className="flex justify-between items-center mb-3">
                            <span className="text-xs font-bold text-slate-500 uppercase tracking-wide">Archivos Visuales</span>
                            <span className="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-500">{attachedImages.length} adjuntos</span>
                        </div>
                        
                        <div className="grid grid-cols-4 gap-3">
                            <div 
                                className="aspect-square border-2 border-dashed border-gray-200 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-[#1B4965] hover:bg-blue-50/30 transition-all group"
                                onClick={() => fileInputRef.current.click()}
                            >
                                <input type="file" multiple accept="image/*" className="hidden" ref={fileInputRef} onChange={handleImageUpload} />
                                <Upload size={20} className="text-gray-300 group-hover:text-[#1B4965] mb-2 transition-colors" />
                                <span className="text-[9px] text-gray-400 font-medium group-hover:text-[#1B4965]">Subir Imagen</span>
                            </div>
                            
                            {attachedImages.map((img, idx) => (
                                <div key={idx} className="relative aspect-square rounded-xl overflow-hidden border border-gray-100 group shadow-sm">
                                    <img src={img} className="w-full h-full object-cover" alt="resource" />
                                    <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
                                    <button 
                                        onClick={() => setAttachedImages(prev => prev.filter((_, i) => i !== idx))}
                                        className="absolute top-1 right-1 bg-white text-red-500 p-1 rounded-full opacity-0 group-hover:opacity-100 shadow-sm hover:bg-red-50 transition-all"
                                    >
                                        <X size={12} />
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>

                <div className="p-4 border-t border-gray-100 bg-gray-50/30 flex justify-end gap-3">
                    <button onClick={onClose} className="btn-base px-6 bg-[#1B4965] text-white hover:bg-[#153a51] shadow-lg shadow-blue-900/5">
                        <Check size={14} /> Guardar
                    </button>
                </div>
            </div>
        </div>
    );
};

const ModificationModal = ({ isOpen, onClose, onApply }) => {
    const [request, setRequest] = useState("");
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm animate-fade-in p-6">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col max-h-[85vh] animate-scale-in border border-white/50">
                <div className="flex justify-between items-center p-5 border-b border-gray-100">
                    <div className="flex items-center gap-2">
                        <div className="bg-blue-50 p-2 rounded-lg"><Sparkles size={16} className="text-blue-500" /></div>
                        <h3 className="font-bold text-sm text-slate-800">Modificar Planificación</h3>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-gray-50 rounded-full text-slate-400 transition-colors"><X size={18}/></button>
                </div>
                <div className="p-6">
                    <textarea 
                        className="w-full h-40 p-4 rounded-xl bg-gray-50 border border-gray-200 text-xs focus:border-blue-400 focus:bg-white focus:ring-2 focus:ring-blue-50 outline-none resize-none transition-all placeholder:text-slate-400"
                        placeholder="Describe los cambios que deseas realizar (ej: 'Cambia la actividad de inicio del martes por algo más dinámico' o 'Ajusta los tiempos del miércoles')..."
                        value={request}
                        onChange={(e) => setRequest(e.target.value)}
                    ></textarea>
                </div>
                <div className="p-4 border-t border-gray-100 bg-gray-50/30 flex justify-end gap-3">
                    <button onClick={onClose} className="btn-base px-4 bg-white border border-gray-200 text-slate-600 hover:bg-gray-50">Cancelar</button>
                    <button onClick={() => { onApply(request); onClose(); setRequest(""); }} className="btn-base px-6 bg-blue-600 text-white hover:bg-blue-700 shadow-lg shadow-blue-500/20">Aplicar Cambios</button>
                </div>
            </div>
        </div>
    );
};

// --- PANTALLA DE INICIO (SPLASH) ---
const IntroScreen = ({ onStart }) => {
    const [isStarting, setIsStarting] = useState(false);

    const handleStart = () => {
        setIsStarting(true);
        setTimeout(onStart, 1200); // 1.2s de animación
    };

    return (
        <div className={`fixed inset-0 z-[100] flex flex-col items-center justify-center bg-[#F9FAFB] transition-opacity duration-500 ${isStarting ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
            <div className="text-center space-y-6 animate-scale-in">
                <div className="w-24 h-24 bg-white rounded-3xl shadow-xl flex items-center justify-center mx-auto border border-gray-100 mb-2">
                    <Layers size={48} className="text-[#1B4965]" />
                </div>
                <div>
                    <h1 className="text-2xl font-black text-[#1B4965] tracking-tight font-montserrat">DIDAC-CLICK</h1>
                    <p className="text-xs font-bold text-gray-400 uppercase tracking-widest mt-1">Plataforma de Planificación</p>
                </div>
                
                <button 
                    onClick={handleStart}
                    disabled={isStarting}
                    className={`group relative flex items-center justify-center gap-3 px-8 bg-[#1B4965] text-white rounded-full font-bold text-sm shadow-lg shadow-blue-900/20 hover:shadow-blue-900/30 hover:-translate-y-0.5 transition-all overflow-hidden w-[220px] ${isStarting ? 'h-10' : 'h-12'}`}
                >
                    {!isStarting && (
                        <>
                            <span className="relative z-10">Iniciar Plataforma</span>
                            <ArrowRight size={16} className="relative z-10 group-hover:translate-x-1 transition-transform" />
                        </>
                    )}
                    {isStarting && (
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-medium animate-pulse">Inicializando módulos...</span>
                        </div>
                    )}
                </button>
            </div>
            <div className="absolute bottom-8 text-[9px] text-gray-300 font-bold uppercase tracking-widest">
                v2.6.0 Stable
            </div>
        </div>
    );
};

// --- APLICACIÓN PRINCIPAL ---

export default function App() {
    const [apiKey] = useState("AIzaSyAe7FaBXxaPTUPpTIhjFrEP-OFvMbMjgdk");
    
    // Estados App
    const [showIntro, setShowIntro] = useState(true);
    
    // Estados Config
    const [subject, setSubject] = useState("");
    const [grade, setGrade] = useState("");
    const [pedagogy, setPedagogy] = useState(""); 
    const [strategy, setStrategy] = useState(""); 
    const [unit, setUnit] = useState("");
    const [topics, setTopics] = useState("");
    const [classCount, setClassCount] = useState(5);
    const [detailLevel, setDetailLevel] = useState("Normal");
    
    // Layout
    const [isSidebarOpen, setIsSidebarOpen] = useState(false); // Sidebar cerrada por defecto

    // Contexto
    const [contextModalOpen, setContextModalOpen] = useState(false);
    const [modificationModalOpen, setModificationModalOpen] = useState(false);
    const [contextText, setContextText] = useState("");
    const [attachedImages, setAttachedImages] = useState([]);

    // UI
    const [isLoading, setIsLoading] = useState(false);
    const [loadingStep, setLoadingStep] = useState(0); 
    const [generatedPlan, setGeneratedPlan] = useState(null);
    const [activeTab, setActiveTab] = useState("lunes"); 
    const [toasts, setToasts] = useState([]);
    
    // Archivos
    const [templateFile, setTemplateFile] = useState(null);
    const [libsLoaded, setLibsLoaded] = useState(false);

    // Listas
    const GRADES = ["1ro Secundaria", "2do Secundaria", "3ro Secundaria", "4to Secundaria", "5to Secundaria", "6to Secundaria", "1ro Primaria", "2do Primaria", "3ro Primaria", "4to Primaria", "5to Primaria", "6to Primaria"];
    const SUBJECTS = ["Lengua Española", "Matemática", "Ciencias Sociales", "Ciencias de la Naturaleza", "Inglés", "Francés", "Ed. Artística", "Ed. Física", "Formación Humana", "Informática"];
    const MODELS = ["Enfoque por Competencias", "Tradicional", "Constructivista", "Conductista", "Socio-Crítico"];
    const STRATEGIES = ["Unidad de Aprendizaje", "Proyecto de Investigación", "Proyecto de Aula", "Eje Temático", "ABP", "Indagación Dialógica", "Estudio de Casos"];
    const DETAIL_LEVELS = ["Breve", "Normal", "Detallada"]; 
    
    const LOADING_MSGS = ["Conectando...", "Analizando...", "Estructurando...", "Redactando...", "Finalizando..."];
    const ALL_DAYS = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];
    const activeDays = ALL_DAYS.slice(0, classCount);
    const defaultDay = { tema: "", inicio: "", desarrollo: "", cierre: "", materiales_docente: "", recursos_alumno: "", tarea: "" };
    const textareasRef = useRef({});

    // Helpers
    const addToast = (msg, type = 'info') => { const id = Date.now(); setToasts(prev => [...prev, { id, message: msg, type }]); };
    const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));

    useEffect(() => {
        const loadScript = (src) => new Promise(res => { if(document.querySelector(`script[src="${src}"]`)) return res(); const s=document.createElement('script'); s.src=src; s.onload=res; document.body.appendChild(s); });
        Promise.all([
            loadScript("https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"),
            loadScript("https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"),
            loadScript("https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js")
        ]).then(() => setLibsLoaded(true));
    }, []);

    const adjustHeight = (e) => { e.target.style.height = 'auto'; e.target.style.height = e.target.scrollHeight + 'px'; };
    
    useEffect(() => {
        if (generatedPlan) Object.values(textareasRef.current).forEach(el => { if(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }});
    }, [generatedPlan, activeTab]);

    const fetchWithRetry = async (url, options, retries = 3) => {
        for (let i = 0; i < retries; i++) {
            try {
                const res = await fetch(url, options);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res;
            } catch (err) {
                if (i === retries - 1) throw err;
                addToast(`Conexión inestable...`, 'loading');
                await new Promise(r => setTimeout(r, 2000));
            }
        }
    };

    const generatePlan = async (modificationRequest = null) => {
        if (!modificationRequest && (!subject || !grade || !unit || !topics)) { 
            addToast("Complete todos los campos de configuración.", 'error'); 
            if (!isSidebarOpen) setIsSidebarOpen(true);
            return; 
        }
        
        setIsLoading(true);
        setLoadingStep(0);
        if (!modificationRequest) setGeneratedPlan(null); 
        
        if (window.innerWidth < 1024) setIsSidebarOpen(false);

        const stepInterval = setInterval(() => setLoadingStep(p => (p < LOADING_MSGS.length - 1 ? p + 1 : p)), 2500);
        
        const detailInstructions = {
            "Breve": "Conciso. Viñetas cortas. Solo 1 actividad principal de desarrollo.",
            "Normal": "Equilibrado. Incluye tiempos. Solo 1 actividad principal de desarrollo.",
            "Detallada": "Exhaustivo. Paso a paso. Solo 1 actividad principal de desarrollo."
        };

        let prompt = "";
        if (modificationRequest) {
            prompt = `
                ACTÚA COMO EDITOR EXPERTO. Modifica el siguiente plan: "${modificationRequest}".
                PLAN ACTUAL: ${JSON.stringify(generatedPlan)}
                REGLAS: Mantén la estructura JSON. Solo cambia lo pedido. NO USES ASTERISCOS NI NEGRITAS.
                Salida JSON: { "plan": { ... } }
            `;
        } else {
            prompt = `
                Rol: Docente Experto. Tarea: Planificar ${classCount} días (${activeDays.join(", ")}) para:
                - Grado: ${grade} | Asignatura: ${subject}
                - Modelo: ${pedagogy} | Estrategia: ${strategy}
                - Unidad: ${unit} | Temas: ${topics}
                - Nivel: ${detailLevel} (${detailInstructions[detailLevel]})
                - Contexto Extra: ${contextText}
                
                REGLAS CRÍTICAS DE CONTENIDO:
                1. La clase dura ESTRICTAMENTE 60 minutos totales.
                2. Distribuye el tiempo de forma lógica (ej: 10 min inicio, 40 desarrollo, 10 cierre). NUNCA excedas 60 min.
                3. Los tiempos estimados NO deben ser idénticos todos los días; varía según la actividad.
                4. **IMPORTANTE:** En la sección de 'Desarrollo', genera SOLO UNA (1) actividad principal robusta, para mantener la brevedad.
                5. **FORMATO:** NO uses asteriscos (*), guiones de lista (-) o Markdown de negrita (**texto**). Escribe en párrafos planos y limpios.
                
                Salida JSON Estricta: { "plan": { "lunes": { "tema": "", "inicio": "", "desarrollo": "", "cierre": "", "materiales_docente": "", "recursos_alumno": "", "tarea": "" }, ... } }
            `;
        }

        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        if (attachedImages.length > 0) payload.contents[0].parts[0].text += "\n[IMÁGENES ADJUNTAS]";

        try {
            const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
            });
            
            const data = await res.json();
            if (data.error) throw new Error(data.error.message);
            
            let jsonText = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '');
            jsonText = jsonText.replace(/\*\*/g, '').replace(/\*/g, '').replace(/__/g, '');
            
            const parsed = JSON.parse(jsonText);
            
            const normalized = {};
            activeDays.forEach(day => {
                const key = day.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const foundKey = Object.keys(parsed.plan || parsed).find(k => k.toLowerCase().includes(key.substring(0,3)));
                normalized[key] = foundKey ? (parsed.plan ? parsed.plan[foundKey] : parsed[foundKey]) : defaultDay;
            });

            clearInterval(stepInterval);
            setLoadingStep(LOADING_MSGS.length - 1);
            
            setTimeout(() => {
                setGeneratedPlan(normalized);
                setActiveTab("lunes");
                setIsLoading(false);
                addToast(modificationRequest ? "Plan modificado" : "Plan generado", 'success');
                setIsSidebarOpen(false);
            }, 800);
             
        } catch (error) { 
            clearInterval(stepInterval);
            addToast("Error de conexión. Reintentando...", 'error'); 
            setIsLoading(false); 
        } 
    };

    const exportWord = () => {
        if (!generatedPlan || !templateFile) { addToast("Falta plan o plantilla.", 'error'); return; }
        const reader = new FileReader();
        reader.onload = (evt) => {
            try {
                const zip = new window.PizZip(evt.target.result);
                const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
                const dataMap = { asignatura: subject, unidad: unit, modelo: pedagogy, estrategia: strategy };
                Object.keys(generatedPlan).forEach(k => {
                    const d = generatedPlan[k];
                    dataMap[`tema_${k}`] = d.tema;
                    ['inicio','desarrollo','cierre','materiales_docente','recursos_alumno','tarea'].forEach(f => dataMap[`${f}_${k}`] = d[f]);
                });
                ALL_DAYS.map(d => d.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "")).forEach(k => {
                    if (!generatedPlan[k]) { dataMap[`tema_${k}`] = ""; ['inicio','desarrollo','cierre','materiales_docente','recursos_alumno','tarea'].forEach(f => dataMap[`${f}_${k}`] = ""); }
                });
                doc.render(dataMap);
                window.saveAs(doc.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" }), `Plan_${subject}.docx`);
                addToast("Archivo descargado", 'success');
            } catch (e) { addToast("Error en plantilla", 'error'); }
        };
        reader.readAsBinaryString(templateFile);
    };

    const handlePlanChange = (key, field, val) => setGeneratedPlan(prev => ({ ...prev, [key]: { ...prev[key], [field]: val } }));

    if (showIntro) return <IntroScreen onStart={() => setShowIntro(false)} />;

    return (
        <div className="flex h-screen w-full bg-white text-slate-800 relative">
            <AppStyles />
            <div className="toast-container">
                {toasts.map(t => <Toast key={t.id} message={t.message} type={t.type} onClose={() => removeToast(t.id)} />)}
            </div>

            <ContextModal isOpen={contextModalOpen} onClose={() => setContextModalOpen(false)} contextText={contextText} setContextText={setContextText} attachedImages={attachedImages} setAttachedImages={setAttachedImages} />
            <ModificationModal isOpen={modificationModalOpen} onClose={() => setModificationModalOpen(false)} onApply={(req) => generatePlan(req)} />

            {/* BOTÓN FLOTANTE SIDEBAR */}
            <button 
                onClick={() => setIsSidebarOpen(!isSidebarOpen)} 
                className={`absolute top-4 z-50 p-2.5 bg-white rounded-xl shadow-lg border border-gray-100 text-slate-500 hover:text-[#1B4965] hover:scale-105 transition-all duration-300 ${isSidebarOpen ? 'left-[265px]' : 'left-6'}`}
            >
                {isSidebarOpen ? <ChevronLeft size={18} /> : <Menu size={18} />}
            </button>

            {/* SIDEBAR RETRÁCTIL */}
            <aside 
                className={`bg-white border-r border-gray-100 flex flex-col shrink-0 z-40 shadow-2xl sidebar-transition h-full absolute md:relative ${isSidebarOpen ? 'w-72 translate-x-0' : 'w-0 -translate-x-full md:w-0 md:translate-x-0 overflow-hidden opacity-0 md:opacity-100'}`}
            >
                {/* HEADER DE MARCA EN SIDEBAR COMPACTO */}
                <div className={`px-6 py-4 border-b border-gray-50 flex flex-col items-center justify-center ${!isSidebarOpen ? 'hidden' : ''}`}>
                    <h2 className="text-xs font-black text-[#1B4965] tracking-[0.15em]">DIDAC-CLICK</h2>
                </div>

                <div className={`p-5 flex-1 overflow-y-auto hide-scroll space-y-4 ${!isSidebarOpen ? 'hidden' : ''}`}>
                    
                    <div className="space-y-3">
                        <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-1">Configuración</span>
                        <CustomSelect placeholder="Grado" value={grade} onChange={setGrade} options={GRADES} />
                        <CustomSelect placeholder="Asignatura" value={subject} onChange={setSubject} options={SUBJECTS} />
                    </div>

                    <div className="space-y-3">
                        <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-1">Metodología</span>
                        <div className="flex flex-col gap-2">
                            <CustomSelect placeholder="Modelo Pedagógico" value={pedagogy} onChange={setPedagogy} options={MODELS} />
                            <CustomSelect placeholder="Estrategia" value={strategy} onChange={setStrategy} options={STRATEGIES} />
                        </div>
                    </div>

                    <div className="space-y-3">
                        <div className="flex justify-between items-center">
                            <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Detalles</span>
                            <div className="flex bg-gray-50 rounded-md p-0.5 border border-gray-100">
                                {[1,2,3,4,5].map(n => (
                                    <button key={n} onClick={() => setClassCount(n)} className={`w-6 h-6 flex items-center justify-center rounded text-[9px] font-bold transition-all ${classCount === n ? 'bg-[#1B4965] text-white shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}>{n}</button>
                                ))}
                            </div>
                        </div>
                        <input value={unit} onChange={e => setUnit(e.target.value)} className="input-compact font-semibold text-[#1B4965]" placeholder="Unidad..." />
                        <div className="pt-1"><CustomSelect placeholder="Nivel de Detalle" value={detailLevel} onChange={setDetailLevel} options={DETAIL_LEVELS} icon={Layers} /></div>
                        <textarea value={topics} onChange={e => setTopics(e.target.value)} className="input-compact h-9" placeholder="Temas..." />
                        <button onClick={() => setContextModalOpen(true)} className="input-compact justify-between hover:border-[#1B4965] transition-colors cursor-pointer group">
                            <div className="flex items-center gap-2 overflow-hidden text-slate-500 group-hover:text-[#1B4965]"><Paperclip size={12} /><span className="truncate">{contextText || attachedImages.length > 0 ? `Contexto (${attachedImages.length})` : "Adjuntar Recursos"}</span></div>
                            {(contextText || attachedImages.length > 0) && <div className="w-1.5 h-1.5 rounded-full bg-[#3A9D9D]"></div>}
                        </button>
                    </div>
                </div>
                
                {/* FOOTER SIDEBAR (Verticalizado) */}
                <div className={`p-5 border-t border-gray-100 bg-white space-y-2 ${!isSidebarOpen ? 'hidden' : ''}`}>
                    <button onClick={() => generatePlan()} disabled={isLoading} className="btn-base bg-[#1B4965] hover:bg-[#153a51] text-white shadow-lg shadow-blue-900/10 disabled:opacity-70 disabled:cursor-wait">GENERAR</button>
                    <div className="flex flex-col gap-2 w-full">
                        <label className="btn-base bg-white border border-gray-200 text-slate-500 hover:border-[#3A9D9D] hover:text-[#3A9D9D] px-2 truncate cursor-pointer w-full"><input type="file" accept=".docx" onChange={e => setTemplateFile(e.target.files[0])} className="hidden" /><span className="truncate">{templateFile ? "Plantilla Cargada" : "Subir Plantilla"}</span></label>
                        <button onClick={exportWord} disabled={!generatedPlan || !templateFile} className="btn-base bg-white border border-gray-200 text-slate-500 hover:bg-emerald-50 hover:border-emerald-200 hover:text-emerald-600 disabled:opacity-50 w-full">Descargar Word</button>
                    </div>
                </div>
            </aside>

            {/* AREA PRINCIPAL */}
            <main className="flex-1 flex flex-col relative bg-[#F9FAFB] overflow-hidden transition-all duration-300">
                {isLoading && (
                    <div className="absolute inset-0 z-30 bg-white/90 backdrop-blur-md flex flex-col items-center justify-center animate-fade-in">
                        <div className="w-64 space-y-4 text-center">
                            <div className="space-y-1">
                                <h3 className="text-xs font-bold text-[#1B4965] uppercase tracking-wider animate-pulse">{LOADING_MSGS[loadingStep]}</h3>
                                <div className="h-0.5 w-full bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-[#3A9D9D] transition-all duration-700 ease-out" style={{ width: `${((loadingStep + 1) / LOADING_MSGS.length) * 100}%` }}></div></div>
                            </div>
                        </div>
                    </div>
                )}

                {!generatedPlan && !isLoading ? (
                    <div className="flex-1 flex flex-col items-center justify-center p-10 select-none opacity-0 animate-fade-in">
                        <div className="mb-8 text-center space-y-3">
                            <div className="w-20 h-20 bg-white rounded-3xl shadow-sm border border-gray-100 flex items-center justify-center mx-auto mb-4">
                                <BookOpen size={32} className="text-[#1B4965] opacity-80" />
                            </div>
                            <h2 className="text-2xl font-black text-[#1B4965] tracking-tight font-montserrat">Planificador Docente</h2>
                            <p className="text-xs text-gray-400 font-medium max-w-sm mx-auto leading-relaxed">
                                Abra el menú lateral para configurar y generar su guía semanal con precisión pedagógica.
                            </p>
                        </div>
                        <div className="w-12 h-1 bg-gray-200 rounded-full mb-8"></div>
                        <span className="text-[10px] font-bold text-gray-300 uppercase tracking-[0.2em]">Powered by DIDAC-CLICK GROUP</span>
                    </div>
                ) : (
                    generatedPlan && (
                        <>
                            <div className="absolute top-6 left-1/2 transform -translate-x-1/2 z-20 flex gap-2 w-full justify-center pointer-events-none">
                                <div className="bg-white/90 backdrop-blur border border-gray-200 p-1 rounded-full shadow-lg shadow-gray-200/50 flex gap-1 pointer-events-auto">
                                    {activeDays.map(day => {
                                        const key = day.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                                        return (
                                            <button key={key} onClick={() => setActiveTab(key)} className={`px-5 py-2 text-[10px] font-bold uppercase rounded-full transition-all ${activeTab === key ? 'bg-[#1B4965] text-white shadow-md' : 'text-gray-400 hover:text-gray-600 hover:bg-gray-50'}`}>{day.substring(0,3)}</button>
                                        );
                                    })}
                                </div>
                            </div>
                            
                            <div className="absolute top-6 right-8 z-20">
                                <button onClick={() => setModificationModalOpen(true)} className="p-2.5 bg-white text-[#1B4965] border border-gray-200 rounded-xl hover:border-[#1B4965] hover:shadow-lg transition-all" title="Modificar con el Sistema"><Edit3 size={18} /></button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-6 md:p-16 hide-scroll scroll-smooth pt-28 relative">
                                <div className="max-w-4xl mx-auto pb-20">
                                    {activeDays.map(day => {
                                        const key = day.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                                        if (key !== activeTab) return null;
                                        const data = generatedPlan[key] || defaultDay;
                                        return (
                                            <div key={key} className="animate-scale-in space-y-5">
                                                <div className="bg-white p-1 rounded-xl border border-gray-100 shadow-sm">
                                                    <div className="px-4 py-2 border-b border-gray-50 bg-gray-50/50 rounded-t-lg">
                                                        <span className="text-[9px] font-bold text-[#3A9D9D] uppercase tracking-wider">Intención Pedagógica / Tema</span>
                                                    </div>
                                                    <textarea className="input-compact font-bold text-[#1B4965] text-sm py-3 px-4 h-auto min-h-[50px] border-0 focus:ring-0 bg-transparent no-horizontal-scroll" value={data.tema} onChange={(e) => { handlePlanChange(key, 'tema', e.target.value); adjustHeight(e); }} placeholder="Tema principal..." rows={1} />
                                                </div>

                                                <div className="space-y-3">
                                                    {['Inicio', 'Desarrollo', 'Cierre'].map((section) => (
                                                        <div key={section} className="relative bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden group hover:border-[#3A9D9D]/30 transition-colors">
                                                            <div className="px-4 py-2 bg-gray-50/30 border-b border-gray-50 flex justify-between items-center">
                                                                <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider group-hover:text-[#1B4965] transition-colors">{section}</span>
                                                            </div>
                                                            <textarea ref={el => textareasRef.current[`${key}-${section}`] = el} className="input-compact min-h-[80px] resize-none no-horizontal-scroll border-0 focus:ring-0 py-3 px-4 text-xs leading-relaxed" value={data[section.toLowerCase()]} onChange={(e) => { handlePlanChange(key, section.toLowerCase(), e.target.value); adjustHeight(e); }} onInput={adjustHeight} rows={1} />
                                                        </div>
                                                    ))}
                                                </div>

                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                                                    <div className="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                                                        <div className="px-4 py-2 bg-gray-50/30 border-b border-gray-50"><span className="text-[9px] font-bold text-gray-400 uppercase tracking-wider">Recursos Docente</span></div>
                                                        <textarea className="input-compact no-horizontal-scroll border-0 focus:ring-0 py-3 px-4 text-xs" rows={2} value={data.materiales_docente} onChange={(e) => handlePlanChange(key, 'materiales_docente', e.target.value)} onInput={adjustHeight} />
                                                    </div>
                                                    <div className="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                                                        <div className="px-4 py-2 bg-gray-50/30 border-b border-gray-50"><span className="text-[9px] font-bold text-gray-400 uppercase tracking-wider">Recursos Estudiante</span></div>
                                                        <textarea className="input-compact no-horizontal-scroll border-0 focus:ring-0 py-3 px-4 text-xs" rows={2} value={data.recursos_alumno} onChange={(e) => handlePlanChange(key, 'recursos_alumno', e.target.value)} onInput={adjustHeight} />
                                                    </div>
                                                    <div className="md:col-span-2 bg-red-50/10 rounded-xl border border-red-50 shadow-sm overflow-hidden hover:border-red-100 transition-colors">
                                                        <div className="px-4 py-2 bg-red-50/20 border-b border-red-50"><span className="text-[9px] font-bold text-[#C00000] uppercase tracking-wider">Evaluación / Tarea</span></div>
                                                        <textarea className="input-compact bg-transparent border-0 focus:ring-0 py-3 px-4 text-xs no-horizontal-scroll" rows={2} value={data.tarea} onChange={(e) => handlePlanChange(key, 'tarea', e.target.value)} onInput={adjustHeight} />
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </>
                    )
                )}
            </main>
        </div>
    );
}